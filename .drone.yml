clone:
  git:
    image: plugins/git
    depth: 1
    when:
        event: push

pipeline:
  install:
    image: mcr.microsoft.com/dotnet/core/sdk:2.2
    commands:
      - dotnet restore
    when:
        event: push

  test:
    image: mcr.microsoft.com/dotnet/core/sdk:2.2
    commands:
      - dotnet test ./Finpe.Test
    when:
        event: push

  lint:
    image: node:10.16.3-alpine
    commands:
      - cd Finpe.React
      - npm install --silent
      - npm run lint
    when:
        event: push

  docker-api:
    image: plugins/docker
    dockerfile: docker/api.Dockerfile
    secrets: [docker_username, docker_password]
    repo: tiagodeliberali/finpeapi
    tag: ["${DRONE_BRANCH}-${DRONE_COMMIT:0:7}", "${DRONE_BRANCH}-latest"]
    build_args:
        - COMMIT=${DRONE_COMMIT:0:7}
    when:
      event: push
      branch: [master, forno]

  docker-front:
    image: plugins/docker
    dockerfile: docker/front.Dockerfile
    secrets: [docker_username, docker_password]
    repo: tiagodeliberali/finpereact
    tag: ["${DRONE_BRANCH}-${DRONE_COMMIT:0:7}", "${DRONE_BRANCH}-latest"]
    build_args:
        - BRANCH=${DRONE_BRANCH}
        - COMMIT=${DRONE_COMMIT:0:7}
    when:
      event: push
      branch: [forno, master]

  sentry-release:
    image: node:10.16.3-alpine
    secrets: [sentry_auth_token]
    commands:
        - cd docker
        - chmod +x ./sentry.sh
        - apk -Uuv add curl ca-certificates
        - ./sentry.sh
    when:
      event: push
      branch: [ master ]
      status: [ success ]

