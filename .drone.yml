clone:
  git:
    image: plugins/git
    depth: 1

pipeline:
  install:
    image: mcr.microsoft.com/dotnet/core/sdk:2.2
    commands:
      - dotnet restore

  test:
    image: mcr.microsoft.com/dotnet/core/sdk:2.2
    commands:
      - dotnet test ./Finpe.Test

  migrate-forno:
    image: mcr.microsoft.com/dotnet/core/sdk:2.2
    environment:
      ConnectionString:
        from_secret: forno_connectionString
    commands:
      - dotnet run --project ./Finpe.Api migrate
    when:
      event: push
      branch: [master]

  docker-forno: 
    image: plugins/docker
    settings:
      repo: tiagodeliberali/finpeapi
      tags: ["${DRONE_BRANCH}-${DRONE_COMMIT:0:7}", "${DRONE_BRANCH}-latest"]
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
    when:
      event: push
      branch: [master]