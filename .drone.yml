clone:
  git:
    image: plugins/git
    depth: 1

pipeline:
  install:
    image: mcr.microsoft.com/dotnet/core/sdk:2.2
    commands:
      - dotnet restore

  test:
    image: mcr.microsoft.com/dotnet/core/sdk:2.2
    commands:
      - dotnet test ./Finpe.Test

  migrate-forno:
    image: mcr.microsoft.com/dotnet/core/sdk:2.2
    commands:
      - echo test1
      - echo $${forno_connectionString}
      - echo test2
      - echo ${forno_connectionString}
      - echo test3
      - echo $forno_connectionString
      - echo test4
      - echo $$forno_connectionString
      - export ConnectionString=$${forno_connectionString}
      - dotnet run --project ./Finpe.Api migrate
    when:
      event: push
      branch: [master]

  docker-forno: 
    image: plugins/docker
    settings:
      repo: tiagodeliberali/finpeapi
      tags: 
        - "forno-${DRONE_COMMIT:0:7}"
        - "forno-latest"
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
    when:
      event: push
      branch: [master]